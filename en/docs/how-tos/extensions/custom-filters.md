# Add Custom Filters
Filters are set of execution points in the request and response flow which will intercept the request before going to the backend service and intercept the response before forwarding to the client.
Filters are applied to all the APIs exposed via Microgateway. Custom filter can be engaged to Microgateway runtime using the Microgateway toolkit.
If there is a common functionality required by all the APIs exposed via the Microgateway then custom filter written in [ballerina language](https://ballerina.io/) can be used for that

##How to add a custom filter
Filters  can be defined in the `deployment-config.toml` file in the project conf (`<PROJECT_HOME>/conf`) folder. 
This project is the Microgateway project which is generated by executing the `micro-gw init <PROJECT_NAME>` command.
Filter has the following methods to intercept the request and the response. Filter name can be any valid name and it is mandatory to have the
`filterRequest` and `filterRequest` methods in the filter object.

!!! info
    It is written in Ballerina 1.2.x so follow API docs in [Ballerina documentation](https://ballerina.io/learn/api-docs/ballerina/) for language guide.

``` ballerina
import ballerina/http;

public type CustomFilter object {

	public function filterRequest(http:Caller caller, http:Request request, http:FilterContext context) returns boolean {
		return true;
	}

	public function filterResponse(http:Response response, http:FilterContext context) returns boolean {
		return true;
	}
}      

```

1. Write the custom filter logic in ballerina language. And save the content in a file with a .bal extension.
``` ballerina

import ballerina/http;

public type CustomFilter object {

	public function filterRequest(http:Caller caller, http:Request request, http:FilterContext context) returns boolean {
		//Check if particular header present in the request. If header is present allow th request otherwise block the request.
		if(request.hasHeader("X-Auth")) {
			return true;
		}
		//If header is missing responds to the client.
		http:Response resp = new;
		resp.setTextPayload("X-Auth header is missing in the request");
		var result = caller->respond(resp);
		return false;
	}

	public function filterResponse(http:Response response, http:FilterContext context) returns boolean {
		return true;
	}
};             

```

2. Copy the implemented .bal file into the `<PROJECT_HOME>/extensions` folder.

3. Define the custom filter in the `deployment-config.toml` as in below. Position starts from index 1.
``` toml
[[filters]]
    name = "CustomFilter"
    position = 1

```

<table>
    <tbody>
        <tr class="odd">
            <td>
                <div class="content-wrapper">
                    <ul><li>
                    <p><strong>name:</strong> Name of the filter object defined in the .bal file. Ex: CustomFiler</p>
                    </li><li>
                    <p><strong>position:</strong>
                    The poistion of the filter to be engaged. By default microgateway has the following set of filters. By defining the position it can engage the custom filter in between any default filter chain</p>
                    <ul><li>
                        <p><strong>gRPC Filter:</strong>Filter to handle gRPC backend services.</p>
                        </li><li>
                        <p><strong>Pre Authentication Filter: </strong> Filter to prepare the request prior to authentication checks</p>
                        </li><li>
                        <p><strong>Authentication Filter:</strong>Handles the authentication based on the different auth types. For ex: OAuth2, Basic and etc</p>
                        </li><li>
                        <p><strong>Authorization Filter:</strong>Handles the Authorization</p>
                        </li><li>
                        <p><strong>Validation Request Filter:</strong>Handles the open API schema validation for the request</p>
                        </li><li>
                        <p><strong>Throttle Filter:</strong>Handles the rate limiting capabilities</p>
                        </li><li>
                        <p><strong>Analytics Filter:</strong>Capture and publish analytics realted dat to analytics server</p>
                        </li><li>
                        <p><strong>Validation Response Filter:</strong>Handles the open API schema validation for the response</p>
                        </li><li>
                        <p><strong>Extension Filter:</strong>Common filter that can be used to customize error messages for authentication,throttling failure releated scenarios</p>
                        </li></ul>
                    </li></ul>
                </div>
            </td>
        </tr>
    </tbody>
</table> 

4.Then build the project. Custom filter will be engaged in the runtime.

##  Skip endpoints for custom filters

To skip filters for health, token, and other similar APIs you can use the filter implementation given below.

1.  Add the following inside the `filterRequest` and `filterResponse` methods.

```
string SKIP_ALL_FILTERS = "skip_filters";
    if (context.attributes.hasKey(SKIP_ALL_FILTERS) && <boolean>context.attributes[SKIP_ALL_FILTERS]) {
    return true;
    }
```
2.  Go to the `deployment.toml` file and add the configuration given below, to set the filter position parameter.

```
[[filters]]
  name = "TestFilter"
  position = 2
```

    !!! note
    If the custom filter chain is prior to the `pre_authn_filter`, then the context will not have the `SKIP_ALL_FILTERS` value set. Therefore, set the custom filter `position` to 2 or greater.

3.  A sample filter implementation is shown below.

```
import ballerina/http;
public type TestFilter object {
public function filterRequest(http:Caller caller, http:Request request, http:FilterContext context) returns boolean {
    string SKIP_ALL_FILTERS = "skip_filters";
    if (context.attributes.hasKey(SKIP_ALL_FILTERS) && <boolean>context.attributes[SKIP_ALL_FILTERS]) {
    return true;
}
request.setHeader("customRequestHeader1", "Value1");
return true;
}
public function filterResponse(http:Response response, http:FilterContext context) returns boolean {
    string SKIP_ALL_FILTERS = "skip_filters";
    if (context.attributes.hasKey(SKIP_ALL_FILTERS) && <boolean>context.attributes[SKIP_ALL_FILTERS]) {
    return true;
    }
response.setHeader("customResponseHeader1", "Value2");
return true;
}
};
```

